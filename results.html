{% extends "base.html" %}

{% block title %}Search Results - PDF Search Engine{% endblock %}

{% block content %}
<section class="dashboard-view active-view">
    <div class="dashboard-section-header">
        <h2>Search Results</h2>
        <div class="section-actions">
            <a href="{{ url_for('search_page') }}" class="btn-secondary">
                <i class="fas fa-search"></i> New Search
            </a>
            <a href="{{ url_for('export_results', query=query) }}" class="btn-secondary">
                <i class="fas fa-file-pdf"></i> Export to PDF
            </a>
        </div>
    </div>
    
    <div class="search-meta">
        <div class="search-info">
            <h3>Results for: <span class="search-query">"{{ query }}"</span></h3>
            <p class="results-count">
                {{ results.total }} match{% if results.total != 1 %}es{% endif %} found in 
                {{ results.file_count }} document{% if results.file_count != 1 %}s{% endif %}
            </p>
        </div>
        
        <div class="results-options">
            {% if results.grouped %}
                <div class="results-grouping-info">Results are grouped by file (showing best match per file)</div>
                <a href="{{ url_for('search', query=query, group='false', page=1) }}" class="btn-secondary btn-sm">
                    <i class="fas fa-list"></i> Show all matches
                </a>
            {% else %}
                <div class="results-grouping-info">Showing all matches</div>
                <a href="{{ url_for('search', query=query, group='true', page=1) }}" class="btn-secondary btn-sm">
                    <i class="fas fa-layer-group"></i> Group by file
                </a>
            {% endif %}
        </div>
    </div>
    
    {% if not results.results or results.results|length == 0 %}
    <div class="no-results">
        <div class="no-results-icon">
            <i class="fas fa-search"></i>
        </div>
        <h3>No results found</h3>
        <p>No documents match your search criteria. Try broadening your search terms or check if your documents are properly indexed.</p>
        
        <!-- Debug info -->
        <div class="debug-info" style="text-align: left; margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
            <h4>Debug Information:</h4>
            <p>Query: "{{ query }}"</p>
            <p>Results count: {{ results.total }}</p>
            <p>Index directory: {{ search_index_dir|default('Not available') }}</p>
            <p>Try rebuilding the index by going to: <a href="{{ url_for('upload_page') }}">Upload & Maintenance</a> page.</p>
        </div>
        
        <a href="{{ url_for('search_page') }}" class="btn-primary">
            <i class="fas fa-search"></i> Try another search
        </a>
    </div>
    {% else %}
    <div class="results-container">
        {% for result in results.results %}
        <div class="result-card">
            <div class="result-header">
                <div class="result-title">
                    <i class="fas fa-file-pdf"></i>
                    <h3>{{ result.filename }}</h3>
                </div>
                <div class="result-actions">
                    <a href="{{ url_for('view_matches', filename=result.filename, query=query) }}" class="btn-primary view-btn">
                        <i class="fas fa-eye"></i> View Matches
                    </a>
                </div>
            </div>
            
            <div class="result-meta">
                <span class="result-page">Page {{ result.page + 1 if result.page is defined else (result['page'] + 1 if result['page'] is defined else '?') }}</span>
                {% if result.context_before or result.context_after %}
                <span class="result-location">Location: {{ result.location if result.location is defined else result['location'] }}</span>
                {% endif %}
            </div>
            
            <div class="result-content">
                {% if result.context_before %}
                <div class="context context-before">{{ result.context_before|safe }}</div>
                {% endif %}
                
                <div class="highlight-content">{{ result.highlight|safe }}</div>
                
                {% if result.context_after %}
                <div class="context context-after">{{ result.context_after|safe }}</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if results.pages > 1 %}
    <div class="pagination">
        {% if results.page > 1 %}
            <a href="{{ url_for('search', query=query, page=results.page-1, group=request.args.get('group', 'true')) }}" class="pagination-item">
                <i class="fas fa-chevron-left"></i> Previous
            </a>
        {% endif %}
        
        {% for p in range(1, results.pages + 1) %}
            <a href="{{ url_for('search', query=query, page=p, group=request.args.get('group', 'true')) }}" 
               class="pagination-item {% if p == results.page %}active{% endif %}">
                {{ p }}
            </a>
        {% endfor %}
        
        {% if results.page < results.pages %}
            <a href="{{ url_for('search', query=query, page=results.page+1, group=request.args.get('group', 'true')) }}" class="pagination-item">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        {% endif %}
    </div>
    {% endif %}
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle dropdown menus
    const dropdowns = document.querySelectorAll('.dropdown');
    
    dropdowns.forEach(dropdown => {
        const toggleBtn = dropdown.querySelector('.dropdown-toggle');
        const menu = dropdown.querySelector('.dropdown-menu');
        
        if (toggleBtn && menu) {
            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                menu.classList.toggle('show');
            });
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function() {
        const openMenus = document.querySelectorAll('.dropdown-menu.show');
        openMenus.forEach(menu => menu.classList.remove('show'));
    });
});
</script>
{% endblock %} 